<!DOCTYPE html>
<html dir="ltr" lang="en-gb">

<!-- Mirrored from forum.abinit.org/viewtopic.php?f=3&t=2347&view=print by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 21 Sep 2024 03:42:55 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="robots" content="noindex" />

<title>ABINIT Discussion Forums &bull; ABINIT 7.4.3 + CUDA cause unstable result</title>

<link href="styles/flat-style/theme/print.css" rel="stylesheet">
<link href="styles/flat-style/theme/bidi.css" rel="stylesheet">
</head>
<body id="phpbb" class="ltr">
<div id="wrap" class="wrap">
	<a id="top" class="top-anchor" accesskey="t"></a>

	<div id="page-header">
		<h1>ABINIT Discussion Forums</h1>
		<p>The meeting place for ABINIT users and developers<br /><a href="index.html">https://forum.abinit.org/</a></p>

		<h2>ABINIT 7.4.3 + CUDA cause unstable result</h2>
		<p><a href="viewtopicdc39.html?f=3&amp;t=2347">https://forum.abinit.org/viewtopic.php?f=3&amp;t=2347</a></p>
	</div>

	<div id="page-body" class="page-body">
		<div class="page-number">Page <strong>1</strong> of <strong>1</strong></div>
					<div class="post">
				<h3>ABINIT 7.4.3 + CUDA cause unstable result</h3>
				<div class="date">Posted: <strong>Wed Nov 27, 2013 11:40 am</strong></div>
				<div class="author">by <strong>f.hayati</strong></div>
				<div class="content">Dear all,<br /><br />We have installed Abinit 7.4.3 on our HPC cluster. The installation looks OK and it detects the GPU correctly and runs without any error. However during the Ground State calculations the result starts to become unstable.<br /><br />For example below is a simple Ground Stage calculation using GPU:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>================================================================================<br /><br />&nbsp; &nbsp; &nbsp;iter&nbsp; &nbsp;Etot(hartree)&nbsp; &nbsp; &nbsp; deltaE(h)&nbsp; residm&nbsp; &nbsp; &nbsp;vres2&nbsp; &nbsp; diffor&nbsp; &nbsp; maxfor<br />&nbsp;ETOT&nbsp; 1&nbsp; -614.67427375897&nbsp; &nbsp; -6.147E+02 4.717E+02 5.900E+03 1.946E-01 1.946E-01<br />&nbsp;ETOT&nbsp; 2&nbsp; -625.17143397088&nbsp; &nbsp; -1.050E+01 4.887E-02 1.056E+04 2.327E-01 2.194E-01<br />&nbsp;ETOT&nbsp; 3&nbsp; -625.43735474989&nbsp; &nbsp; -2.659E-01 2.372E-02 1.982E+02 1.783E-01 4.997E-02<br />&nbsp;ETOT&nbsp; 4&nbsp; -625.44870336575&nbsp; &nbsp; -1.135E-02 2.902E-03 5.599E+02 3.648E-02 5.826E-02<br />&nbsp;ETOT&nbsp; 5&nbsp; -625.45241712954&nbsp; &nbsp; -3.714E-03 5.347E-03 1.229E+02 8.376E-02 2.770E-02<br />&nbsp;ETOT&nbsp; 6&nbsp; -625.42948954513&nbsp; &nbsp; &nbsp;2.293E-02 2.676E-03 1.610E+03 8.347E-02 1.090E-01<br />&nbsp;ETOT&nbsp; 7&nbsp; -625.45235843257&nbsp; &nbsp; -2.287E-02 1.504E-03 4.714E+02 5.455E-02 6.004E-02<br />&nbsp;ETOT&nbsp; 8&nbsp; -625.45289293032&nbsp; &nbsp; -5.345E-04 1.467E-03 3.796E+02 3.038E-02 3.688E-02<br />&nbsp;ETOT&nbsp; 9&nbsp; -625.46020574598&nbsp; &nbsp; -7.313E-03 1.359E-03 8.227E+01 3.441E-02 7.403E-03<br />&nbsp;ETOT 10&nbsp; -625.45992937236&nbsp; &nbsp; &nbsp;2.764E-04 6.554E-04 9.409E+01 2.631E-03 6.256E-03<br />&nbsp;ETOT 11&nbsp; -625.45957973008&nbsp; &nbsp; &nbsp;3.496E-04 8.895E-04 1.165E+02 1.607E-02 1.591E-02<br />&nbsp;ETOT 12&nbsp; -625.45996211767&nbsp; &nbsp; -3.824E-04 4.067E-04 1.027E+02 7.077E-03 2.299E-02<br />&nbsp;ETOT 13&nbsp; -625.45998908711&nbsp; &nbsp; -2.697E-05 4.992E-04 1.366E+02 2.326E-02 4.625E-02<br />&nbsp;ETOT 14&nbsp; -625.46077744096&nbsp; &nbsp; -7.884E-04 4.742E-04 1.007E+02 4.907E-03 4.617E-02<br />&nbsp;ETOT 15&nbsp; -625.46155659717&nbsp; &nbsp; -7.792E-04 4.376E-04 4.587E+01 1.227E-02 3.390E-02<br />&nbsp;ETOT 16&nbsp; -625.46185049469&nbsp; &nbsp; -2.939E-04 4.852E-04 3.050E+01 5.599E-03 3.256E-02<br />&nbsp;ETOT 17&nbsp; -625.46179040979&nbsp; &nbsp; &nbsp;6.008E-05 3.677E-04 3.270E+01 1.225E-03 3.164E-02<br />&nbsp;ETOT 18&nbsp; -625.46148686775&nbsp; &nbsp; &nbsp;3.035E-04 3.539E-04 6.483E+01 1.174E-02 4.337E-02<br />&nbsp;ETOT 19&nbsp; -625.46092150417&nbsp; &nbsp; &nbsp;5.654E-04 1.575E-03 1.074E+02 9.513E-03 5.289E-02<br />&nbsp;ETOT 20&nbsp; -625.46142489640&nbsp; &nbsp; -5.034E-04 2.135E-03 6.336E+01 1.155E-02 4.133E-02<br />&nbsp;ETOT 21&nbsp; -625.46176207532&nbsp; &nbsp; -3.372E-04 2.658E-03 2.207E+01 2.015E-02 2.119E-02<br />&nbsp;ETOT 22&nbsp; -625.46202927714&nbsp; &nbsp; -2.672E-04 4.456E-03 4.347E-01 1.980E-02 1.393E-03<br />&nbsp;ETOT 23&nbsp; -625.46204446163&nbsp; &nbsp; -1.518E-05 9.901E-03 1.162E-01 2.197E-03 9.645E-04<br />&nbsp;ETOT 24&nbsp; -625.46205698647&nbsp; &nbsp; -1.252E-05 1.422E-02 1.500E-02 1.269E-03 1.237E-03<br />&nbsp;ETOT 25&nbsp; -625.46205970161&nbsp; &nbsp; -2.715E-06 2.804E-02 5.794E-03 8.660E-04 1.459E-03<br />&nbsp;ETOT 26&nbsp; -625.46213203883&nbsp; &nbsp; -7.234E-05 2.571E-02 3.322E-03 2.309E-04 1.228E-03<br />&nbsp;ETOT 27&nbsp; -625.46229354344&nbsp; &nbsp; -1.615E-04 6.794E-02 1.857E-03 5.736E-04 1.275E-03<br />&nbsp;ETOT 28&nbsp; -625.46241877821&nbsp; &nbsp; -1.252E-04 9.490E-02 7.197E-04 8.970E-05 1.262E-03<br />&nbsp;ETOT 29&nbsp; -625.46239955130&nbsp; &nbsp; &nbsp;1.923E-05 1.396E-01 9.224E-04 1.458E-05 1.254E-03<br />&nbsp;ETOT 30&nbsp; -625.46479403242&nbsp; &nbsp; -2.394E-03 1.801E+01 2.448E-03 2.343E-04 1.194E-03<br />&nbsp;ETOT 31&nbsp; -625.46206179995&nbsp; &nbsp; &nbsp;2.732E-03 1.455E+00 8.336E-04 8.157E-05 1.259E-03<br />&nbsp;ETOT 32&nbsp; -625.46188952129&nbsp; &nbsp; &nbsp;1.723E-04 1.463E+00 6.354E-04 8.958E-05 1.258E-03<br />&nbsp;ETOT 33&nbsp; -625.46197051877&nbsp; &nbsp; -8.100E-05 9.567E-02 1.040E-04 1.539E-04 1.242E-03<br />&nbsp;ETOT 34&nbsp; -625.46194943353&nbsp; &nbsp; &nbsp;2.109E-05 1.130E+00 5.291E-04 4.825E-05 1.213E-03<br />&nbsp;ETOT 35&nbsp; -625.46276205637&nbsp; &nbsp; -8.126E-04 1.489E-01 2.987E-04 3.724E-05 1.235E-03<br />&nbsp;ETOT 36&nbsp; -625.46292613056&nbsp; &nbsp; -1.641E-04 2.252E-01 3.962E-04 8.574E-05 1.160E-03<br />&nbsp;ETOT 37&nbsp; -625.46318942199&nbsp; &nbsp; -2.633E-04 9.648E+00 3.699E-03 2.828E-04 1.173E-03<br />&nbsp;ETOT 38&nbsp; -625.46969350540&nbsp; &nbsp; -6.504E-03 2.534E+01 2.352E-02 1.798E-04 1.042E-03<br />&nbsp;ETOT 39&nbsp; -625.46363128740&nbsp; &nbsp; &nbsp;6.062E-03 2.135E+01 2.685E-03 1.814E-04 1.141E-03<br />&nbsp;ETOT 40&nbsp; -625.46421352465&nbsp; &nbsp; -5.822E-04 2.165E+01 2.219E-03 1.400E-04 1.200E-03<br />&nbsp;ETOT 41&nbsp; -625.46627147493&nbsp; &nbsp; -2.058E-03 2.148E+01 6.273E-03 7.285E-05 1.171E-03<br />&nbsp;ETOT 42&nbsp; -625.46400768318&nbsp; &nbsp; &nbsp;2.264E-03 2.956E+01 2.827E-03 1.545E-04 1.295E-03<br />&nbsp;ETOT 43&nbsp; -625.46171156333&nbsp; &nbsp; &nbsp;2.296E-03 6.034E+00 2.025E-03 1.006E-04 1.194E-03<br />&nbsp;ETOT 44&nbsp; -625.46153823985&nbsp; &nbsp; &nbsp;1.733E-04 1.252E+00 4.623E-03 1.111E-04 1.290E-03<br />&nbsp;ETOT 45&nbsp; -625.46180218026&nbsp; &nbsp; -2.639E-04 4.374E-01 1.607E-03 2.003E-04 1.271E-03<br />&nbsp;ETOT 46&nbsp; -625.46189523391&nbsp; &nbsp; -9.305E-05 1.387E-01 1.602E-03 3.773E-05 1.233E-03<br />&nbsp;ETOT 47&nbsp; -625.46198486281&nbsp; &nbsp; -8.963E-05 9.258E-02 4.528E-05 2.187E-04 1.246E-03<br />&nbsp;ETOT 48&nbsp; -625.46200178156&nbsp; &nbsp; -1.692E-05 2.015E-02 3.491E-05 1.829E-05 1.252E-03<br />&nbsp;ETOT 49&nbsp; -625.46201898264&nbsp; &nbsp; -1.720E-05 8.556E-03 3.869E-05 8.890E-06 1.247E-03<br />&nbsp;ETOT 50&nbsp; -625.46230267849&nbsp; &nbsp; -2.837E-04 1.240E-01 1.303E-06 7.283E-06 1.243E-03<br />&nbsp;ETOT 51&nbsp; -625.46202695009&nbsp; &nbsp; &nbsp;2.757E-04 6.509E-02 3.273E-05 1.534E-05 1.251E-03<br />&nbsp;ETOT 52&nbsp; -625.46201688702&nbsp; &nbsp; &nbsp;1.006E-05 4.299E-03 3.603E-05 5.260E-06 1.253E-03<br />&nbsp;ETOT 53&nbsp; -625.46214993996&nbsp; &nbsp; -1.331E-04 4.811E-02 1.676E-05 4.655E-06 1.251E-03<br />&nbsp;ETOT 54&nbsp; -625.46204091336&nbsp; &nbsp; &nbsp;1.090E-04 2.675E-02 2.879E-05 7.792E-06 1.251E-03<br />&nbsp;ETOT 55&nbsp; -628.03593538990&nbsp; &nbsp; -2.574E+00 3.079E+03 3.862E+02 4.657E-02 4.532E-02<br />&nbsp;ETOT 56&nbsp; -627.17880347739&nbsp; &nbsp; &nbsp;8.571E-01 1.285E+03 2.445E+02 1.494E-02 3.038E-02<br />&nbsp;ETOT 57&nbsp; -626.12131376390&nbsp; &nbsp; &nbsp;1.057E+00 2.699E+03 6.884E+01 2.024E-02 1.343E-02<br />&nbsp;ETOT 58&nbsp; -626.00415509520&nbsp; &nbsp; &nbsp;1.172E-01 3.814E+02 5.156E+01 5.683E-03 7.752E-03<br />&nbsp;ETOT 59&nbsp; -627.38439375739&nbsp; &nbsp; -1.380E+00 3.416E+03 2.786E+02 2.669E-02 3.354E-02<br />&nbsp;ETOT 60&nbsp; -632.95425743477&nbsp; &nbsp; -5.570E+00 4.342E+03 1.054E+03 1.026E-01 1.315E-01<br />&nbsp;ETOT 61&nbsp; -650.16880154160&nbsp; &nbsp; -1.721E+01 2.119E+04 2.427E+03 2.645E-01 3.960E-01<br />&nbsp;ETOT 62&nbsp; -635.45601580413&nbsp; &nbsp; &nbsp;1.471E+01 8.000E+03 1.322E+03 2.270E-01 1.690E-01<br />&nbsp;ETOT 63&nbsp; -654.94809236847&nbsp; &nbsp; -1.949E+01 1.144E+04 2.631E+03 2.831E-01 4.475E-01<br />&nbsp;ETOT 64&nbsp; -893.64730728837&nbsp; &nbsp; -2.387E+02 1.807E+05 6.825E+03 2.771E+00 3.218E+00<br />&nbsp;ETOT 65&nbsp; -728.14012678208&nbsp; &nbsp; &nbsp;1.655E+02 5.614E+04 4.884E+03 1.815E+00 1.428E+00<br />&nbsp;ETOT 66&nbsp; -1043.5032395855&nbsp; &nbsp; -3.154E+02 4.429E+05 7.792E+03 3.224E+00 4.627E+00<br />&nbsp;ETOT 67&nbsp; -3634.9490307075&nbsp; &nbsp; -2.591E+03 1.044E+06 1.165E+04 1.729E+01 2.192E+01<br />&nbsp;ETOT 68&nbsp; -8397.8304723706&nbsp; &nbsp; -4.763E+03 1.181E+06 1.302E+04 2.361E+01 4.553E+01<br />&nbsp;ETOT 69&nbsp; -104390.57286085&nbsp; &nbsp; -9.599E+04 1.404E+07 1.528E+04 2.950E+02 3.405E+02<br />&nbsp;ETOT 70&nbsp; -19029.180990350&nbsp; &nbsp; &nbsp;8.536E+04 5.049E+06 1.367E+04 2.555E+02 8.506E+01<br />&nbsp;ETOT 71&nbsp; -22443.391627179&nbsp; &nbsp; -3.414E+03 9.421E+06 1.483E+04 2.685E+01 1.062E+02<br />&nbsp;ETOT 72&nbsp; -53781.205583605&nbsp; &nbsp; -3.134E+04 6.185E+06 1.281E+04 1.052E+02 1.480E+02<br />&nbsp;ETOT 73&nbsp; -350903.81671060&nbsp; &nbsp; -2.971E+05 3.494E+07 1.256E+04 4.965E+02 6.007E+02<br />&nbsp;ETOT 74&nbsp; -797082.79203942&nbsp; &nbsp; -4.462E+05 5.181E+07 1.128E+04 6.468E+02 1.111E+03<br />&nbsp;ETOT 75&nbsp; -273544.63610541&nbsp; &nbsp; &nbsp;5.235E+05 3.695E+07 7.505E+03 8.899E+02 3.069E+02<br />&nbsp;ETOT 76&nbsp; -392045.68540145&nbsp; &nbsp; -1.185E+05 4.876E+07 7.573E+03 3.715E+02 4.900E+02<br />&nbsp;ETOT 77&nbsp; -1790072.7958265&nbsp; &nbsp; -1.398E+06 1.423E+08 3.189E+03 5.472E+02 1.037E+03<br />&nbsp;ETOT 78&nbsp; -8518335.8132030&nbsp; &nbsp; -6.728E+06 3.485E+08 9.323E+02 2.488E+03 1.451E+03<br />&nbsp;ETOT 79&nbsp; -8027037.8074598&nbsp; &nbsp; &nbsp;4.913E+05 2.116E+08 3.640E+03 2.411E+03 3.862E+03<br />&nbsp;ETOT 80&nbsp; -14497554.703925&nbsp; &nbsp; -6.471E+06 6.400E+08 2.495E+03 1.495E+03 3.852E+03<br />&nbsp;ETOT 81&nbsp; -2642857.3088491&nbsp; &nbsp; &nbsp;1.185E+07 1.605E+08 2.909E+03 2.605E+03 1.246E+03<br />&nbsp;ETOT 82&nbsp; -6999151.4590077&nbsp; &nbsp; -4.356E+06 1.853E+08 1.176E+04 3.211E+03 4.457E+03<br />&nbsp;ETOT 83&nbsp; -92241497.370347&nbsp; &nbsp; -8.524E+07 1.064E+09 2.420E+02 2.680E+03 5.682E+03<br />&nbsp;ETOT 84&nbsp; -496249710.79844&nbsp; &nbsp; -4.040E+08 7.721E+09 1.344E+01 8.434E+03 6.337E+03<br />&nbsp;ETOT 85&nbsp; -349355358.81005&nbsp; &nbsp; &nbsp;1.469E+08 6.006E+09 3.341E+01 7.370E+03 4.686E+03<br />&nbsp;ETOT 86&nbsp; -690958872.02225&nbsp; &nbsp; -3.416E+08 9.879E+09 6.304E-01 4.962E+03 2.220E+03<br />&nbsp;ETOT 87&nbsp; -1526464156.5710&nbsp; &nbsp; -8.355E+08 9.610E+09 2.742E+00 7.782E+03 7.955E+03<br />&nbsp;ETOT 88&nbsp; -485404640.40571&nbsp; &nbsp; &nbsp;1.041E+09 1.031E+10 1.479E-01 7.006E+03 9.493E+02<br />&nbsp;ETOT 89&nbsp; -13980219.489800&nbsp; &nbsp; &nbsp;4.714E+08 1.238E+09 2.443E-01 9.715E+02 4.652E+01<br />&nbsp;ETOT 90&nbsp; -9260982.1081759&nbsp; &nbsp; &nbsp;4.719E+06 6.860E+08 1.948E-01 2.779E+01 1.873E+01<br />&nbsp;ETOT 91&nbsp; -3103866.6737715&nbsp; &nbsp; &nbsp;6.157E+06 7.555E+08 8.005E-01 2.923E+01 1.866E+01<br />&nbsp;ETOT 92&nbsp; -1158202.5009766&nbsp; &nbsp; &nbsp;1.946E+06 6.250E+08 1.663E+00 1.118E+01 7.476E+00<br />&nbsp;ETOT 93&nbsp; -1628667.1855357&nbsp; &nbsp; -4.705E+05 7.143E+08 7.381E-01 1.244E+01 4.965E+00<br />&nbsp;ETOT 94&nbsp; -3379321.6251889&nbsp; &nbsp; -1.751E+06 2.617E+08 6.826E-01 1.005E+01 1.295E+01<br />&nbsp;ETOT 95&nbsp; -343399.17585614&nbsp; &nbsp; &nbsp;3.036E+06 1.130E+08 4.333E+00 1.324E+01 4.648E+00<br />&nbsp;ETOT 96&nbsp; -2027875.1023575&nbsp; &nbsp; -1.684E+06 2.281E+08 6.816E-01 4.991E+00 9.157E+00<br />&nbsp;ETOT 97&nbsp; -4527325.3363628&nbsp; &nbsp; -2.499E+06 1.628E+08 3.346E-01 3.947E+00 1.261E+01<br />&nbsp;ETOT 98&nbsp; -13750774.583784&nbsp; &nbsp; -9.223E+06 5.468E+08 1.548E-01 2.454E+01 3.715E+01<br />&nbsp;ETOT 99&nbsp; -6615240.6457553&nbsp; &nbsp; &nbsp;7.136E+06 3.729E+08 2.532E-01 1.521E+01 2.194E+01<br />&nbsp;ETOT&nbsp; 100&nbsp; -1487759.0490269&nbsp; &nbsp; &nbsp;5.127E+06 4.633E+08 1.131E+00 1.952E+01 8.834E+00<br /><br />&nbsp;scprqt:&nbsp; WARNING -<br />&nbsp; nstep=&nbsp; 100 was not enough SCF cycles to converge;<br />&nbsp; potential residual=&nbsp; 1.131E+00 exceeds tolvrs=&nbsp; 1.000E-12<br /></code></pre></div><br />You can see from 50th iteration the system starts to become unstable, while running the same script without using GPU leads to convergence after 43 iterations as listed below:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>================================================================================<br /><br />&nbsp; &nbsp; &nbsp;iter&nbsp; &nbsp;Etot(hartree)&nbsp; &nbsp; &nbsp; deltaE(h)&nbsp; residm&nbsp; &nbsp; &nbsp;vres2&nbsp; &nbsp; diffor&nbsp; &nbsp; maxfor<br />&nbsp;ETOT&nbsp; 1&nbsp; -614.67427375897&nbsp; &nbsp; -6.147E+02 4.717E+02 5.900E+03 1.946E-01 1.946E-01<br />&nbsp;ETOT&nbsp; 2&nbsp; -625.17143397088&nbsp; &nbsp; -1.050E+01 4.887E-02 1.056E+04 2.327E-01 2.194E-01<br />&nbsp;ETOT&nbsp; 3&nbsp; -625.43735474989&nbsp; &nbsp; -2.659E-01 2.372E-02 1.982E+02 1.783E-01 4.997E-02<br />&nbsp;ETOT&nbsp; 4&nbsp; -625.44870333943&nbsp; &nbsp; -1.135E-02 2.902E-03 5.599E+02 3.648E-02 5.826E-02<br />&nbsp;ETOT&nbsp; 5&nbsp; -625.45242405097&nbsp; &nbsp; -3.721E-03 5.341E-03 1.227E+02 8.372E-02 2.768E-02<br />&nbsp;ETOT&nbsp; 6&nbsp; -625.42951148671&nbsp; &nbsp; &nbsp;2.291E-02 2.677E-03 1.609E+03 8.346E-02 1.089E-01<br />&nbsp;ETOT&nbsp; 7&nbsp; -625.45236462880&nbsp; &nbsp; -2.285E-02 1.503E-03 4.711E+02 5.452E-02 6.002E-02<br />&nbsp;ETOT&nbsp; 8&nbsp; -625.45289954886&nbsp; &nbsp; -5.349E-04 1.468E-03 3.792E+02 3.039E-02 3.684E-02<br />&nbsp;ETOT&nbsp; 9&nbsp; -625.46020258128&nbsp; &nbsp; -7.303E-03 1.357E-03 8.238E+01 3.441E-02 7.381E-03<br />&nbsp;ETOT 10&nbsp; -625.45993109615&nbsp; &nbsp; &nbsp;2.715E-04 6.665E-04 9.402E+01 2.606E-03 6.245E-03<br />&nbsp;ETOT 11&nbsp; -625.45956897175&nbsp; &nbsp; &nbsp;3.621E-04 8.892E-04 1.171E+02 1.628E-02 1.611E-02<br />&nbsp;ETOT 12&nbsp; -625.45995970528&nbsp; &nbsp; -3.907E-04 4.121E-04 1.031E+02 7.142E-03 2.325E-02<br />&nbsp;ETOT 13&nbsp; -625.46001760244&nbsp; &nbsp; -5.790E-05 4.989E-04 1.339E+02 2.234E-02 4.559E-02<br />&nbsp;ETOT 14&nbsp; -625.46081833914&nbsp; &nbsp; -8.007E-04 4.563E-04 9.762E+01 5.111E-03 4.553E-02<br />&nbsp;ETOT 15&nbsp; -625.46153912087&nbsp; &nbsp; -7.208E-04 4.420E-04 4.727E+01 1.120E-02 3.433E-02<br />&nbsp;ETOT 16&nbsp; -625.46182012216&nbsp; &nbsp; -2.810E-04 4.702E-04 3.493E+01 4.468E-03 3.460E-02<br />&nbsp;ETOT 17&nbsp; -625.46175654526&nbsp; &nbsp; &nbsp;6.358E-05 3.755E-04 3.649E+01 1.303E-03 3.330E-02<br />&nbsp;ETOT 18&nbsp; -625.46160983850&nbsp; &nbsp; &nbsp;1.467E-04 3.460E-04 5.703E+01 8.550E-03 4.185E-02<br />&nbsp;ETOT 19&nbsp; -625.46090254058&nbsp; &nbsp; &nbsp;7.073E-04 2.623E-04 1.203E+02 1.633E-02 5.818E-02<br />&nbsp;ETOT 20&nbsp; -625.46176897178&nbsp; &nbsp; -8.664E-04 2.040E-04 2.251E+01 3.546E-02 2.271E-02<br />&nbsp;ETOT 21&nbsp; -625.46189436686&nbsp; &nbsp; -1.254E-04 1.370E-04 1.081E+01 7.634E-03 1.508E-02<br />&nbsp;ETOT 22&nbsp; -625.46201162069&nbsp; &nbsp; -1.173E-04 1.085E-04 2.970E-01 1.403E-02 1.291E-03<br />&nbsp;ETOT 23&nbsp; -625.46201548672&nbsp; &nbsp; -3.866E-06 1.033E-04 1.162E-01 5.557E-04 1.596E-03<br />&nbsp;ETOT 24&nbsp; -625.46201557276&nbsp; &nbsp; -8.603E-08 6.328E-05 3.339E-02 8.990E-04 1.404E-03<br />&nbsp;ETOT 25&nbsp; -625.46201581900&nbsp; &nbsp; -2.462E-07 7.313E-05 7.643E-04 8.262E-04 1.304E-03<br />&nbsp;ETOT 26&nbsp; -625.46201578657&nbsp; &nbsp; &nbsp;3.244E-08 5.447E-05 4.402E-04 1.106E-04 1.246E-03<br />&nbsp;ETOT 27&nbsp; -625.46201571842&nbsp; &nbsp; &nbsp;6.815E-08 4.970E-05 1.346E-04 3.715E-05 1.250E-03<br />&nbsp;ETOT 28&nbsp; -625.46201573272&nbsp; &nbsp; -1.430E-08 4.536E-05 1.276E-06 4.976E-05 1.247E-03<br />&nbsp;ETOT 29&nbsp; -625.46201572899&nbsp; &nbsp; &nbsp;3.728E-09 3.809E-05 1.889E-06 8.842E-06 1.250E-03<br />&nbsp;ETOT 30&nbsp; -625.46201573455&nbsp; &nbsp; -5.564E-09 4.280E-05 1.315E-06 7.209E-06 1.249E-03<br />&nbsp;ETOT 31&nbsp; -625.46201573341&nbsp; &nbsp; &nbsp;1.142E-09 3.527E-05 1.427E-06 9.650E-06 1.251E-03<br />&nbsp;ETOT 32&nbsp; -625.46201573163&nbsp; &nbsp; &nbsp;1.782E-09 3.923E-05 1.958E-08 4.146E-06 1.250E-03<br />&nbsp;ETOT 33&nbsp; -625.46201573071&nbsp; &nbsp; &nbsp;9.254E-10 3.174E-05 9.487E-08 6.736E-07 1.249E-03<br />&nbsp;ETOT 34&nbsp; -625.46201573132&nbsp; &nbsp; -6.112E-10 3.498E-05 1.789E-09 1.519E-06 1.249E-03<br />&nbsp;ETOT 35&nbsp; -625.46201573159&nbsp; &nbsp; -2.717E-10 2.784E-05 1.193E-08 8.205E-07 1.249E-03<br />&nbsp;ETOT 36&nbsp; -625.46201573145&nbsp; &nbsp; &nbsp;1.374E-10 3.043E-05 1.586E-10 5.692E-07 1.249E-03<br />&nbsp;ETOT 37&nbsp; -625.46201573149&nbsp; &nbsp; -3.502E-11 2.387E-05 1.467E-10 2.241E-08 1.249E-03<br />&nbsp;ETOT 38&nbsp; -625.46201573149&nbsp; &nbsp; -9.095E-13 2.592E-05 9.312E-11 2.447E-08 1.249E-03<br />&nbsp;ETOT 39&nbsp; -625.46201573151&nbsp; &nbsp; -1.955E-11 2.165E-05 4.730E-12 5.574E-08 1.249E-03<br />&nbsp;ETOT 40&nbsp; -625.46201573150&nbsp; &nbsp; &nbsp;5.684E-12 2.168E-05 7.849E-12 6.289E-09 1.249E-03<br />&nbsp;ETOT 41&nbsp; -625.46201573151&nbsp; &nbsp; -1.091E-11 2.287E-05 2.422E-12 4.698E-09 1.249E-03<br />&nbsp;ETOT 42&nbsp; -625.46201573151&nbsp; &nbsp; &nbsp;2.956E-12 1.786E-05 3.201E-12 2.839E-09 1.249E-03<br />&nbsp;ETOT 43&nbsp; -625.46201573151&nbsp; &nbsp; -3.411E-12 2.382E-05 5.239E-13 6.703E-09 1.249E-03<br /><br />&nbsp;At SCF step&nbsp; &nbsp;43&nbsp; &nbsp; &nbsp; &nbsp;vres2&nbsp; &nbsp;=&nbsp; 5.24E-13 &lt; tolvrs=&nbsp; 1.00E-12 =&gt;converged.<br /></code></pre></div><br />As you can see the first few iterations are identical but when Abinit uses the GPU it starts to become unstable.<br /><br />The node is equipped with a Tesla K20 GPU and Abinit detects the device correctly:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>-P-0000<br />-P-0000&nbsp; setdevice_cuda : COMMENT -<br />-P-0000&nbsp; &nbsp;GPU 0 has been properly initialized, continuing...<br />-P-0000<br />-P-0000&nbsp; ________________________________________________________________________________<br />-P-0000&nbsp; ________________________ Graphic Card Properties _______________________________<br />-P-0000<br />-P-0000&nbsp; &nbsp; &nbsp;Device&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 : Tesla K20c<br />-P-0000&nbsp; &nbsp; &nbsp;Revision number:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3.5<br />-P-0000&nbsp; &nbsp; &nbsp;Total amount of global memory:&nbsp; 4799.6 Mbytes<br />-P-0000&nbsp; &nbsp; &nbsp;Clock rate:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.7 GHz<br />-P-0000&nbsp; &nbsp; &nbsp;Max GFLOP:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 73 GFP<br />-P-0000&nbsp; &nbsp; &nbsp;Total&nbsp; constant memory:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 65536 bytes<br />-P-0000&nbsp; &nbsp; &nbsp;Shared memory per block:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;49152 bytes<br />-P-0000&nbsp; &nbsp; &nbsp;Number of registers per block:&nbsp; &nbsp;65536<br />-P-0000<br />-P-0000&nbsp; ________________________________________________________________________________<br />-P-0000<br /></code></pre></div><br />and this is the build information:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>=== Build Information === <br />&nbsp; Version&nbsp; &nbsp; &nbsp; &nbsp;: 7.4.3<br />&nbsp; Build target&nbsp; : x86_64_linux_intel13.0<br />&nbsp; Build date&nbsp; &nbsp; : 20131113<br />&nbsp;<br />&nbsp;=== Compiler Suite === <br />&nbsp; C compiler&nbsp; &nbsp; &nbsp; &nbsp;: intel13.0<br />&nbsp; CFLAGS&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:&nbsp; -g -O2 -vec-report0<br />&nbsp; C++ compiler&nbsp; &nbsp; &nbsp;: intel13.0<br />&nbsp; CXXFLAGS&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:&nbsp; -g -O2 -vec-report0<br />&nbsp; Fortran compiler : intel13.0<br />&nbsp; FCFLAGS&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; :&nbsp; -g -extend-source -vec-report0 -noaltparam -nofpscomp<br />&nbsp; FC_LDFLAGS&nbsp; &nbsp; &nbsp; &nbsp;:&nbsp; &nbsp; -static-intel -static-libgcc<br />&nbsp;<br />&nbsp;=== Optimizations === <br />&nbsp; Debug level&nbsp; &nbsp; &nbsp; &nbsp; : basic<br />&nbsp; Optimization level : standard<br />&nbsp; Architecture&nbsp; &nbsp; &nbsp; &nbsp;: intel_xeon<br />&nbsp;<br />&nbsp;=== MPI === <br />&nbsp; Parallel build : yes<br />&nbsp; Parallel I/O&nbsp; &nbsp;: auto<br />&nbsp; Time tracing&nbsp; &nbsp;: no<br />&nbsp; GPU support&nbsp; &nbsp; : yes<br />&nbsp;<br />&nbsp;=== Connectors / Fallbacks === <br />&nbsp; Connectors on : yes<br />&nbsp; Fallbacks on&nbsp; : yes<br />&nbsp; DFT flavor&nbsp; &nbsp; : libxc+atompaw+bigdft-fallback+wannier90<br />&nbsp; FFT flavor&nbsp; &nbsp; : fftw3-mkl<br />&nbsp; LINALG flavor : mkl<br />&nbsp; MATH flavor&nbsp; &nbsp;: none<br />&nbsp; TIMER flavor&nbsp; : abinit<br />&nbsp; TRIO flavor&nbsp; &nbsp;: netcdf-fallback+etsf_io-fallback+fox-fallback<br />&nbsp;<br />&nbsp;=== Experimental features === <br />&nbsp; Bindings&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : no<br />&nbsp; Exports&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: no<br />&nbsp; GW double-precision : yes<br />&nbsp;<br />&nbsp;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<br />&nbsp;<br /><br />&nbsp;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<br />&nbsp;Default optimizations:<br />&nbsp; &nbsp;-O2 -xHost<br /><br /><br />&nbsp;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<br /><br /><br />&nbsp;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<br />&nbsp;CPP options activated during the build:<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CC_INTEL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CXX_INTEL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FC_INTEL<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HAVE_DFT_ATOMPAW&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_DFT_BIGDFT&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HAVE_DFT_LIBXC<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; HAVE_DFT_WANNIER90 HAVE_FC_ALLOCATABLE_DT...&nbsp; &nbsp; &nbsp; &nbsp; HAVE_FC_CONTIGUOUS<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_FC_CPUTIME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_FC_ETIME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HAVE_FC_EXIT<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_FC_FLUSH&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_FC_GAMMA&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HAVE_FC_GETENV<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HAVE_FC_GETPID&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_FC_IOMSG&nbsp; &nbsp; &nbsp;HAVE_FC_ISO_C_BINDING<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; HAVE_FC_LONG_LINES&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HAVE_FC_NULL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_FC_STREAM_IO<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HAVE_FFT&nbsp; &nbsp; &nbsp; &nbsp; HAVE_FFT_FFTW3_MKL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HAVE_FFT_MPI<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_FFT_SERIAL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HAVE_GPU&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_GPU_CUDA<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HAVE_GPU_CUDA_DP&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_GPU_SERIAL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_LINALG<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_LINALG_AXPBY&nbsp; &nbsp; &nbsp; &nbsp; HAVE_LINALG_GEMM3M&nbsp; HAVE_LINALG_MKL_IMATCOPY<br /><br />&nbsp; &nbsp;HAVE_LINALG_MKL_OMATADD&nbsp; HAVE_LINALG_MKL_OMATCOPY&nbsp; &nbsp; &nbsp; &nbsp; HAVE_LINALG_SERIAL<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HAVE_MPI&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_MPI2&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_MPI_IO<br /><br />&nbsp;HAVE_MPI_TYPE_CREATE_S...&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_OS_LINUX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HAVE_TIMER<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_TIMER_ABINIT&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HAVE_TIMER_MPI&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_TIMER_SERIAL<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_TRIO_ETSF_IO&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_TRIO_FOX&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HAVE_TRIO_NETCDF<br /><br />&nbsp;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<br /></code></pre></div><br /><br />Finally, this is the configuration script that has been used to build Abinit:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>/configure \ <br />--prefix=&quot;/gpfs/apps/abinit/v7.4.3_cuda&quot; \ <br />--enable-mpi \ <br />--with-mpi-prefix=&quot;$MPI_HOME&quot; \ <br />--with-fft-flavor=&quot;fftw3-mkl&quot; \ <br />--with-fft-libs=&quot;-L$MKLROOT/lib/intel64 -lmkl_intel_lp64 -lmkl_sequential -lmkl_core -lpthread -lm&quot; \ <br />--with-linalg-flavor=&quot;mkl&quot; \ <br />--with-linalg-libs=&quot;-L$MKLROOT/lib/intel64 -lmkl_intel_lp64 -lmkl_sequential -lmkl_core -lpthread -lm&quot; \ <br />--enable-atompaw --with-atompaw-bins=&quot;$ATOMPAW_HOME/bin&quot; --with-atompaw-libs=&quot;-L$ATOMPAW_HOME/lib -latompaw&quot; \ <br />--with-libxc-incs=&quot;-I$LIBXC_HOME/include&quot; --with-libxc-libs=&quot;-L$LIBXC_HOME/lib -lxc&quot; \ <br />--enable-wannier90 --with-wannier90-bins=&quot;$WANNIER_ROOT&quot; --with-wannier90-libs=&quot;-L$WANNIER_ROOT -lwannier&quot;\ <br />--with-dft-flavor=&quot;atompaw+bigdft+libxc+wannier90&quot; \ <br />--with-trio-flavor=&quot;etsf_io+fox+netcdf&quot; \ <br />--enable-clib=&quot;yes&quot; \ <br />--enable-gw-dpc=&quot;yes&quot; \ <br />--enable-gpu \ <br />FC=mpif90 CC=mpicc CXX=mpiCC <br /></code></pre></div><br /><br />Can you think of anything that might cause the instability of Abinit using GPU during calculation?<br /><br />Thank you very much in advanced,<br />Farzad</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: ABINIT 7.4.3 + CUDA cause unstable result</h3>
				<div class="date">Posted: <strong>Fri Nov 29, 2013 9:30 am</strong></div>
				<div class="author">by <strong>jbeuken</strong></div>
				<div class="content">Hi,<br /><br />first, the min version of intel compiler must be  &gt;= 13.0.1 or &gt;= 13.1.3<br /><br />next, this is the cuda.ac file used to test the support of CUDA in ABINIT in our test farm :<br /><br /><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>enable_mpi = yes<br />enable_mpi_io = yes<br />with_mpi_prefix = /usr/local/openmpi_gcc46<br />with_dft_flavor = none<br />with_trio_flavor = none<br />enable_gw_dpc = yes<br />#<br />with_linalg_flavor = mkl+magma<br />with_linalg_incs = -I${MAGMA_ROOT}/include -I${MKLROOT}/include<br />with_linalg_libs = -L${MAGMA_ROOT}/lib -Wl,--start-group -lmagma -lmagmablas -lcuda -Wl,--end-group -L${MKLROOT} -lmkl_scalapack_lp64 -lmkl_gf_lp64 -lmkl_sequential -lmkl_core -lmkl_blacs_openmpi_lp64 -lpthread -lm<br />#<br />enable_gpu = yes<br />with_gpu_flavor = cuda-double<br />NVCC_CFLAGS = -O3 -arch=sm_13 -Xptxas=-v --use_fast_math --compiler-options -O3,-fPIC<br />#<br />FC_LDFLAGS_EXTRA = -Wl,-z,muldefs<br /></code></pre></div><br /><br />then, use the command :<br /><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>./configure --with-config-file=./cuda.ac</code></pre></div><br /><br />I hope it can help you,<br /><br />jmb</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: ABINIT 7.4.3 + CUDA cause unstable result</h3>
				<div class="date">Posted: <strong>Tue Dec 03, 2013 11:45 am</strong></div>
				<div class="author">by <strong>f.hayati</strong></div>
				<div class="content">Dear Beuken,<br /><br />Thank you for your prompt reply. <br />I've talked to our HPC Service Manager regarding the changes you suggested. Unfortunately due to work load at this time of the year he is unable to look into a new build before New Year. Consequently, I am unable to provide any update until after New Year. I will update this thread as soon as we applied your suggestions to the new build.<br /><br />Warmest wishes,<br />Farzad</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: ABINIT 7.4.3 + CUDA cause unstable result</h3>
				<div class="date">Posted: <strong>Thu Oct 16, 2014 5:14 pm</strong></div>
				<div class="author">by <strong>mike7</strong></div>
				<div class="content">Hello.<br />I get the same result with 7.8.2 +cuda+gfortran 4.6 +mkl+magma 1.5:  in the respfn teph1 tutorial, it does not converge from the start. I had to set fftalg=112 to make it work at all, but then it does not converge within 800 iterations. If I set use_gpu_cuda=0 in the input file, it works.<br />Here is my config, I also tried to vary some parameters taking them from other configurations, but it does not make any difference.<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>enable_mpi=&quot;yes&quot;<br />enable_mpi_io=&quot;yes&quot;<br />with_mpi_prefix=&quot;/usr&quot;<br />NVCC=/usr/local/cuda-6.0/bin/nvcc<br />#NVCC_CFLAGS=&quot;-arch=sm_30 -Xptxas=-v --use_fast_math --compiler-options -O3,-fPIC&quot;<br />NVCC_CPPFLAGS=&quot;-arch=sm_30 -Xptxas=-v --use_fast_math --compiler-options -O3,-fPIC&quot;<br />#with_dft_flavor=none<br />#with_trio_flavor=none<br />#with_fft_flavor=&quot;fftw3&quot;<br />#with_fft_incs=&quot;-I/usr/include/&quot;<br />#with_fft_libs=&quot;-L/usr/lib/x86-64-linux-gnu/ -lfftw3 -lfftw3f&quot;<br />enable_gw_dpc=yes<br />with_linalg_flavor=&quot;mkl+magma&quot;<br />with_linalg_incs=&quot;-I${MAGMA_ROOT}/include -I/home/mike/mkl/include&quot;<br />#with_linalg_libs=&quot;-L${MAGMA_ROOT}/lib -Wl,--start-group -lmagma -lcuda -Wl,--end-group -L${MKLROOT} -lmkl_scalapack_lp64 -lmkl_intel_lp64 -lmkl_sequential -lmkl_core -lmkl_blacs_openmpi_lp64 -lpthread -lm&quot;<br />with_linalg_libs=&quot;-L/home/mike/mkl/lib/intel64 -lmkl_scalapack_lp64 -lmkl_blacs_lp64 -Wl,--start-group -L/home/mike/mkl/lib/intel64 -lmkl_gf_lp64 -lmkl_core -lmkl_sequential -Wl,--end-group -L/home/mike/mkl/lib/intel64/ -ldl -lpthread -lm -L${MAGMA_ROOT}/lib -lmagma -lcuda&quot;<br />enable_gpu=&quot;yes&quot;<br />with_gpu_flavor=&quot;cuda-double&quot;<br />#NVCC_CFLAGS=&quot;-O3 -arch=sm_30 -Xptxas=-v --use_fast_math --compiler-options -O3,-fPIC&quot;<br />#with-nvcc-flags=&quot;-O3 -arch=sm_30 -Xptxas=-v --use_fast_math --compiler-options -O3,-fPIC&quot;<br />FC_LDFLAGS_EXTRA=-Wl,-z,muldefs -pthread</code></pre></div><br /><br />For non-cuda version, it does work fine, all tests pass, I tried in different configurations.</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: ABINIT 7.4.3 + CUDA cause unstable result</h3>
				<div class="date">Posted: <strong>Fri Oct 17, 2014 10:50 am</strong></div>
				<div class="author">by <strong>Jordan</strong></div>
				<div class="content">Please read these threads : <a href="viewtopic4dd3.html?f=2&amp;t=2729#p8425" class="postlink">http://forum.abinit.org/viewtopic.php?f=2&amp;t=2729#p8425</a> and <a href="viewtopic4dd3.html?f=2&amp;t=2729#p8437" class="postlink">http://forum.abinit.org/viewtopic.php?f=2&amp;t=2729#p8437</a>.<br />If you can try to downgrade your libraries to the one tested, we'll know if there is an issue due them or not.<br /><br />Cheers<br /><br />Jordan</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: ABINIT 7.4.3 + CUDA cause unstable result</h3>
				<div class="date">Posted: <strong>Sat Oct 18, 2014 1:04 pm</strong></div>
				<div class="author">by <strong>mike7</strong></div>
				<div class="content">Thank you for suggestions. <br />I compiled magma 1.5.0 and 1.2.1 and abinit 7.8.2 with intel 13.0.1, gcc 4.6 and 4.8 and cuda 6.0 and 6.5 in different combinations. Also replaced scalapack with lapack95. It does not improve anything.<br />It looks like intel 13 fails very often in the tests with segfault, in the same tests gnu compiler usually gives unstability or slightly different result exceeding tolerance.<br />I used &quot;fast&quot;,  &quot;gpu&quot; and &quot;tutorespfn&quot; keywords when testing. <br />For example, &quot;gpu&quot; group tests 2 and 4 success, 1 and 3 either pass or fail with error slightly exceeding tolerance. Changes in compiler/libary versions changes result from pass to fail and back. The runtime of tests is often 2-3 times or more higher than non-gpu version. <br /><br />For example, &quot;fast&quot; test summary:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>&#91;fast&#93;&#91;t17-t19-t20-t21-t23&#93; &nbsp; &nbsp;failed &nbsp; &nbsp;7.56 &nbsp; &nbsp;7.65<br />&#91;fast&#93;&#91;t25&#93;&#91;np=1&#93; &nbsp; &nbsp;failed &nbsp; &nbsp;1.12 &nbsp; &nbsp;1.15<br />&#91;fast&#93;&#91;t27-t28-t29&#93; &nbsp; &nbsp;failed &nbsp; &nbsp;8.99 &nbsp; &nbsp;9.16<br />&#91;fast&#93;&#91;t00&#93;&#91;np=1&#93; &nbsp; &nbsp;succeeded &nbsp; &nbsp;1.53 &nbsp; &nbsp;1.64<br />&#91;fast&#93;&#91;t01&#93;&#91;np=1&#93; &nbsp; &nbsp;succeeded &nbsp; &nbsp;1.09 &nbsp; &nbsp;1.13<br />&#91;fast&#93;&#91;t02&#93;&#91;np=1&#93; &nbsp; &nbsp;succeeded &nbsp; &nbsp;2.63 &nbsp; &nbsp;2.69<br />&#91;fast&#93;&#91;t03-t05-t06-t07-t08-t09-t11-t12-t14-t16&#93; &nbsp; &nbsp;succeeded &nbsp; &nbsp;11.90 &nbsp; &nbsp;12.36<br />&#91;fast&#93;&#91;t04&#93;&#91;np=1&#93; &nbsp; &nbsp;succeeded &nbsp; &nbsp;0.68 &nbsp; &nbsp;0.70<br />&#91;fast&#93;&#91;t24&#93;&#91;np=1&#93; &nbsp; &nbsp;succeeded &nbsp; &nbsp;1.27 &nbsp; &nbsp;1.32<br />&#91;fast&#93;&#91;t26&#93;&#91;np=1&#93; &nbsp; &nbsp;succeeded &nbsp; &nbsp;1.13 &nbsp; &nbsp;1.15<br />&#91;fast&#93;&#91;t30&#93;&#91;np=1&#93; &nbsp; &nbsp;succeeded &nbsp; &nbsp;0.90 &nbsp; &nbsp;0.96 </code></pre></div><br /><br />For non-cuda version, fast group has one passed and all other success. <br /><br />But I needed abinit for teph_1 tutorial, it does not converge anyway. Also I compared output, with cuda it sets fftalg=112, useylm=1 and lmnmax=9 , without 312,0,3 - that is the only difference in displayed parameters.</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: ABINIT 7.4.3 + CUDA cause unstable result</h3>
				<div class="date">Posted: <strong>Mon Oct 20, 2014 9:52 am</strong></div>
				<div class="author">by <strong>Jordan</strong></div>
				<div class="content">The only tests actually tested on GPU in our test farm are &quot;gpu&quot;<br />All the other tests are not expected to succeed with GPU, altough they should....<br />So please consider testing with ../../tests/runtests.py gpu to confirm that at least these tests pass.<br /><br />The FFT problem, namely fftalg is changed from 312 to 112 isn't relevant since in the CPU case the FFT is performed by the CPU with the FFTW3 library, whereas when the GPU version is activated and one GPU is detected then the FFT is done by the GPU using the cuFFT library.<br /><br />Note that the parameters to converge on CPU might be different than for GPU what could explained that in some cases you don't converge on one but this other.<br /><br />The GPU implementation is now a few years old (around 3 to 4) and is not often used/improved/checked (despite the 4 GPU tests we have), meaning it can be outdated. Furthermore, the speed up using GPU  is around x3 ou x4 which can be slower than using a fast multicore cpu with in between 6 to 16 cores (or more), depending on what you want to achieve. So the question is, is it worth to spend a lot of time making the GPU version working ? In some cases, it is ( I used them when I could not have access to a large number of CPU which were in addition very slow).<br /><br />Hope that helps<br /><br />Jordan</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: ABINIT 7.4.3 + CUDA cause unstable result</h3>
				<div class="date">Posted: <strong>Tue Oct 21, 2014 7:26 pm</strong></div>
				<div class="author">by <strong>mike7</strong></div>
				<div class="content">Hello.<br />I tested with gpu test group and the tests all are shown as fail. But looking into the files reveal that except for 4th test, 3 first ones have many differences between very small numbers like 1e-30 . The 4th test has larger error, the pressure tensor is different in the 3rd digit. What is also visible is that the results are different on every run i.e. those small numbers are not the same. So it looks like uninitialized variables when using gpu.<br />I also measured the speed: the usage of mkl improves the speed by 1.5 times and makes 1 cpu equal or a little faster than 1 gpu version. I needed GPU version to use abinit with a supercomputer which has 80% of power in GPUs.<br /><br />Also I reduced the input file for the response function tutorial where I noticed inconvergence:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>nband&nbsp; &nbsp; &nbsp; &nbsp; 3<br /><br />tolvrs 1.e-8 <br />kptopt&nbsp; 1<br />ngkpt&nbsp; &nbsp; &nbsp; &nbsp; 4 4 4<br />ecut&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4.0<br />nshiftk&nbsp; &nbsp; &nbsp; 1<br />shiftk&nbsp; &nbsp; &nbsp; &nbsp;0.0 0.0 0.0<br />acell&nbsp; &nbsp; &nbsp; &nbsp; 3*7.5<br />rprim<br />&nbsp;0.0 0.5 0.5<br />&nbsp;0.5 0.0 0.5<br />&nbsp;0.5 0.5 0.0<br />occopt&nbsp; &nbsp; &nbsp; &nbsp;3<br />tsmear&nbsp; &nbsp; &nbsp; &nbsp;0.001<br />natom&nbsp; &nbsp; &nbsp; &nbsp; 1<br />typat&nbsp; &nbsp; &nbsp; &nbsp; 1<br />xred&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 0.00 0.00<br />nstep&nbsp; &nbsp; &nbsp; &nbsp; 800<br />ntypat&nbsp; &nbsp; &nbsp; &nbsp;1<br />znucl&nbsp; &nbsp; &nbsp; &nbsp; 13<br /></code></pre></div><br />If I change nband from 2 to 3, it does not converge - at that iteration where it is supposed to converge, the energy starts to oscillate. For 2 it converges but gives a little different result as compared to CPU version. Maybe that will give you a clue where the error is.</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: ABINIT 7.4.3 + CUDA cause unstable result</h3>
				<div class="date">Posted: <strong>Thu Oct 23, 2014 11:18 am</strong></div>
				<div class="author">by <strong>Jordan</strong></div>
				<div class="content">I can not give you the solution/explanation right now but we will investigate very soon and will provide more information on the supported libraries for GPU.<br />We'll try also to provide more gpu tests.<br /><br />About your input file, you are considering a metallic system with a fermi-dirac distribution. Depending on the number of valence electrons (I guess 3) in your pseudopotential, you may not have enough bands with nband=2, occopt 3 and tsmear 0.001. Please check that you have at least one empty band in your calculation. If not, increase nband until the last band is at most 0.000 in the log or output file and compare the results GPU/CPU<br /><br />Jordan</div>
			</div>
			<hr />
			</div>

	<div id="page-footer" class="page-footer">
		<div class="page-number">All times are <span title="Europe/Brussels">UTC+02:00</span><br />Page <strong>1</strong> of <strong>1</strong></div>
			<div class="copyright">
				<p>Powered by <a href="https://www.phpbb.com/">phpBB</a>&reg; Forum Software &copy; phpBB Limited
				</p>
							</div>
	</div>
</div>

</body>

<!-- Mirrored from forum.abinit.org/viewtopic.php?f=3&t=2347&view=print by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 21 Sep 2024 03:42:55 GMT -->
</html>
