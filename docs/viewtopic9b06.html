<!DOCTYPE html>
<html dir="ltr" lang="en-gb">

<!-- Mirrored from forum.abinit.org/viewtopic.php?f=9&t=3739&view=print by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 21 Sep 2024 03:01:44 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="robots" content="noindex" />

<title>ABINIT Discussion Forums &bull; Improve efficiency in bulk water calculation</title>

<link href="styles/flat-style/theme/print.css" rel="stylesheet">
<link href="styles/flat-style/theme/bidi.css" rel="stylesheet">
</head>
<body id="phpbb" class="ltr">
<div id="wrap" class="wrap">
	<a id="top" class="top-anchor" accesskey="t"></a>

	<div id="page-header">
		<h1>ABINIT Discussion Forums</h1>
		<p>The meeting place for ABINIT users and developers<br /><a href="index.html">https://forum.abinit.org/</a></p>

		<h2>Improve efficiency in bulk water calculation</h2>
		<p><a href="viewtopicb67c.html?f=9&amp;t=3739">https://forum.abinit.org/viewtopic.php?f=9&amp;t=3739</a></p>
	</div>

	<div id="page-body" class="page-body">
		<div class="page-number">Page <strong>1</strong> of <strong>1</strong></div>
					<div class="post">
				<h3>Improve efficiency in bulk water calculation</h3>
				<div class="date">Posted: <strong>Fri Dec 01, 2017 1:00 pm</strong></div>
				<div class="author">by <strong>Daniel_M</strong></div>
				<div class="content">Dear all,<br /><br />I am making some tests with a bulk water system (128 H2O molecules, cubic cell a = 15.66 angstrom, structure obtained from classical MD at 300 K). I am interested just in single point calculations for getting energy and forces at the PBE level at gamma point only, so from what I understand the only way of improving the efficiency is playing with the parallelization at the band and fft level. I am doing the tests in a Tier-0 supercomputer but it seems to me that my calculations are very slow, compared to the same calculation with other codes (e.g. CP2K, Siesta...) in the same machine, hence I think there is something quite wrong with my setup or compilation.<br />First, the output of abinit -b is this:<br /><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>&nbsp;DATA TYPE INFORMATION: <br />&nbsp;REAL:&nbsp; &nbsp; &nbsp; Data type name: REAL(DP) <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Kind value:&nbsp; &nbsp; &nbsp; 8<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Precision:&nbsp; &nbsp; &nbsp; 15<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Smallest nonnegligible quantity relative to 1:&nbsp; 0.22204460E-15<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Smallest positive number:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.22250739-307<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Largest representable number:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.17976931+309<br />&nbsp;INTEGER:&nbsp; &nbsp;Data type name: INTEGER(default) <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Kind value: 4<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Bit size:&nbsp; &nbsp;32<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Largest representable number: 2147483647<br />&nbsp;LOGICAL:&nbsp; &nbsp;Data type name: LOGICAL <br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Kind value: 4<br />&nbsp;CHARACTER: Data type name: CHARACTER&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Kind value: 1<br />&nbsp; ==== Using MPI-2 specifications ==== <br />&nbsp; MPI-IO support is ON<br />&nbsp; xmpi_tag_ub ................&nbsp; &nbsp;2147483647<br />&nbsp; xmpi_bsize_ch ..............&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1<br />&nbsp; xmpi_bsize_int .............&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4<br />&nbsp; xmpi_bsize_sp ..............&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4<br />&nbsp; xmpi_bsize_dp ..............&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8<br />&nbsp; xmpi_bsize_spc .............&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8<br />&nbsp; xmpi_bsize_dpc .............&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;16<br />&nbsp; xmpio_bsize_frm ............&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4<br />&nbsp; xmpi_address_kind ..........&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8<br />&nbsp; xmpi_offset_kind ...........&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8<br />&nbsp; MPI_WTICK ..................&nbsp; &nbsp;1.000000000000000E-006<br /><br />&nbsp;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<br />&nbsp;CPP options activated during the build:<br /><br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CC_INTEL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CXX_INTEL&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FC_INTEL<br />&nbsp;<br />&nbsp;HAVE_FC_ALLOCATABLE_DT...&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_FC_ASYNC&nbsp; HAVE_FC_COMMAND_ARGUMENT<br />&nbsp;<br />&nbsp; &nbsp; &nbsp; HAVE_FC_COMMAND_LINE&nbsp; &nbsp; &nbsp; &nbsp; HAVE_FC_CONTIGUOUS&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_FC_CPUTIME<br />&nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_FC_ETIME&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HAVE_FC_EXIT&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_FC_FLUSH<br />&nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_FC_GAMMA&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HAVE_FC_GETENV&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HAVE_FC_GETPID<br />&nbsp;<br />&nbsp; &nbsp;HAVE_FC_IEEE_EXCEPTIONS&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_FC_IOMSG&nbsp; &nbsp; &nbsp;HAVE_FC_ISO_C_BINDING<br />&nbsp;<br />&nbsp; HAVE_FC_ISO_FORTRAN_2008&nbsp; &nbsp; &nbsp; &nbsp; HAVE_FC_LONG_LINES&nbsp; &nbsp; &nbsp; &nbsp; HAVE_FC_MOVE_ALLOC<br />&nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_FC_PRIVATE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_FC_PROTECTED&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_FC_STREAM_IO<br />&nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HAVE_FC_SYSTEM&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HAVE_FFT&nbsp; &nbsp; &nbsp; &nbsp; HAVE_FFT_FFTW3_MKL<br />&nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HAVE_FFT_MPI&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_FFT_SERIAL&nbsp; &nbsp; &nbsp; &nbsp; HAVE_LIBPAW_ABINIT<br />&nbsp;<br />&nbsp; &nbsp; &nbsp; HAVE_LIBTETRA_ABINIT&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_LINALG&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_LINALG_AXPBY<br />&nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; HAVE_LINALG_GEMM3M&nbsp; HAVE_LINALG_MKL_IMATCOPY&nbsp; &nbsp;HAVE_LINALG_MKL_OMATADD<br />&nbsp;<br />&nbsp; HAVE_LINALG_MKL_OMATCOPY&nbsp; &nbsp;HAVE_LINALG_MKL_THREADS&nbsp; &nbsp; &nbsp; &nbsp; HAVE_LINALG_SERIAL<br />&nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HAVE_MPI&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_MPI2&nbsp; &nbsp; &nbsp; &nbsp;HAVE_MPI_IALLREDUCE<br />&nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; HAVE_MPI_IALLTOALL&nbsp; &nbsp; &nbsp; &nbsp;HAVE_MPI_IALLTOALLV&nbsp; &nbsp; &nbsp; &nbsp; HAVE_MPI_INTEGER16<br />&nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_MPI_IO HAVE_MPI_TYPE_CREATE_S...&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_OS_LINUX<br />&nbsp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;HAVE_TIMER_ABINIT&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; USE_MACROAVE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />&nbsp;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<br /><br />&nbsp;<br />&nbsp;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<br />&nbsp;<br />&nbsp;=== Build Information === <br />&nbsp; Version&nbsp; &nbsp; &nbsp; &nbsp;: 8.6.1<br />&nbsp; Build target&nbsp; : x86_64_linux_intel17.0<br />&nbsp; Build date&nbsp; &nbsp; : 20171130<br />&nbsp;<br />&nbsp;=== Compiler Suite === <br />&nbsp; C compiler&nbsp; &nbsp; &nbsp; &nbsp;: intel17.0<br />&nbsp; C++ compiler&nbsp; &nbsp; &nbsp;: intel17.0<br />&nbsp; Fortran compiler : intel17.0<br />&nbsp; CFLAGS&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: -mkl<br />&nbsp; CXXFLAGS&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;:&nbsp; -g -O2 -vec-report0<br />&nbsp; FCFLAGS&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : -mkl<br />&nbsp; FC_LDFLAGS&nbsp; &nbsp; &nbsp; &nbsp;: <br />&nbsp;<br />&nbsp;=== Optimizations === <br />&nbsp; Debug level&nbsp; &nbsp; &nbsp; &nbsp; : basic<br />&nbsp; Optimization level : standard<br />&nbsp; Architecture&nbsp; &nbsp; &nbsp; &nbsp;: intel_xeon<br />&nbsp;<br />&nbsp;=== Multicore === <br />&nbsp; Parallel build : yes<br />&nbsp; Parallel I/O&nbsp; &nbsp;: yes<br />&nbsp; openMP support : no<br />&nbsp; GPU support&nbsp; &nbsp; : no<br />&nbsp;<br />&nbsp;=== Connectors / Fallbacks === <br />&nbsp; Connectors on : yes<br />&nbsp; Fallbacks on&nbsp; : yes<br />&nbsp; DFT flavor&nbsp; &nbsp; : none<br />&nbsp; FFT flavor&nbsp; &nbsp; : fftw3-mkl<br />&nbsp; LINALG flavor : mkl<br />&nbsp; MATH flavor&nbsp; &nbsp;: none<br />&nbsp; TIMER flavor&nbsp; : abinit<br />&nbsp; TRIO flavor&nbsp; &nbsp;: none<br />&nbsp;<br />&nbsp;=== Experimental features === <br />&nbsp; Bindings&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : @enable_bindings@<br />&nbsp; Exports&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: no<br />&nbsp; GW double-precision : no<br />&nbsp;<br />&nbsp;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<br /><br />&nbsp;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<br />&nbsp;Default optimizations:<br />&nbsp; &nbsp;--- None ---<br />&nbsp;++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++<br /><br /></code></pre></div><br /><br />And the input (irrelevant parts abbreviated) is:<br /><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>atom 384<br />ntypat 2<br />znucl 8 1<br />typat 1 2 2 ....<br />ionmov 0<br /><br />nstep 100<br />toldfe 1.0d-5<br /><br />ecut 150 Ry<br /><br />kptopt 0<br />nkpt 1<br />kpt 0 0 0<br />nband 528<br />paral_kgb 1<br />npband 48<br />npfft 6<br />fftalg 401<br /><br />chksymbreak 0<br />acell 3*15.6626780696 angstrom<br />nsym 1<br />symrel 1 0 0 0 1 0 0 0 1<br />xangst&nbsp; ...<br /></code></pre></div><br /><br />Now, some observations:<br /><br />- When I try using &quot;fftalg 312&quot;, the calculation stops with &quot;FFTW3 support not activated&quot;. This should be fixed by including the flags HAVE_FFT_FFTW3 and/or HAVE_FFT_FFTW3_THREADS when compiling, right?<br /><br />- I tried with &quot;autoparal 3&quot;, but it seems to me it is better to set manually npband and npfft. It seem also obvious that they must be such npband*npfft = total no. of cores, at least in this calculation where there are no k-points or spin involved. Am I right or am I missing something obvious?<br /><br />- You may think that ecut is too high. This is bacause I am making tests to check convergence of the forces wrt the cutoff, which is not yet reached for 150 Ry. From what I know from some other codes the convergence may be improved by applying some smoothing on the density for the xc calculation (e.g. see Appendix in Jonchiere et al. JCP , 135, 154503 (2011)). Is it something similar implemented in abinit?<br /><br />I will be very thankful for any comment that may help me improve this calculation.  Thanks a lot, <br />D.</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: Improve efficiency in bulk water calculation</h3>
				<div class="date">Posted: <strong>Thu Jul 26, 2018 11:12 am</strong></div>
				<div class="author">by <strong>Annelinde</strong></div>
				<div class="content">Hi,<br /><br />I don't have a solution, but I also noticed bad scaling of the parallelisation in nanoribbons (lots of electronic bands, little kpoints) on Tier-1 and Tier-2 machines. I concluded that kpoint-parallelisation must be the most efficient in ABINIT, and when you can't make use of this kind of parallelisation, your calculation is terribly slow. I don't know why this is.<br /><br />with kind regards,<br /><br />Annelinde</div>
			</div>
			<hr />
			</div>

	<div id="page-footer" class="page-footer">
		<div class="page-number">All times are <span title="Europe/Brussels">UTC+02:00</span><br />Page <strong>1</strong> of <strong>1</strong></div>
			<div class="copyright">
				<p>Powered by <a href="https://www.phpbb.com/">phpBB</a>&reg; Forum Software &copy; phpBB Limited
				</p>
							</div>
	</div>
</div>

</body>

<!-- Mirrored from forum.abinit.org/viewtopic.php?f=9&t=3739&view=print by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 21 Sep 2024 03:01:44 GMT -->
</html>
