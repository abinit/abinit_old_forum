<!DOCTYPE html>
<html dir="ltr" lang="en-gb">

<!-- Mirrored from forum.abinit.org/viewtopic.php?f=12&t=483&view=print by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 20 Sep 2024 21:03:11 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="robots" content="noindex" />

<title>ABINIT Discussion Forums &bull; [anaddb] 77_ddb/sortph.F90 fails to connect branches</title>

<link href="styles/flat-style/theme/print.css" rel="stylesheet">
<link href="styles/flat-style/theme/bidi.css" rel="stylesheet">
</head>
<body id="phpbb" class="ltr">
<div id="wrap" class="wrap">
	<a id="top" class="top-anchor" accesskey="t"></a>

	<div id="page-header">
		<h1>ABINIT Discussion Forums</h1>
		<p>The meeting place for ABINIT users and developers<br /><a href="index.html">https://forum.abinit.org/</a></p>

		<h2>[anaddb] 77_ddb/sortph.F90 fails to connect branches</h2>
		<p><a href="viewtopicf8b8.html?f=12&amp;t=483">https://forum.abinit.org/viewtopic.php?f=12&amp;t=483</a></p>
	</div>

	<div id="page-body" class="page-body">
		<div class="page-number">Page <strong>1</strong> of <strong>1</strong></div>
					<div class="post">
				<h3>[anaddb] 77_ddb/sortph.F90 fails to connect branches</h3>
				<div class="date">Posted: <strong>Sat Jul 10, 2010 5:00 am</strong></div>
				<div class="author">by <strong>t-nissie</strong></div>
				<div class="content">Hi all,<br /><br />77_ddb/sortph.F90 sometimes fails to connect branches correctly.<br />Here are my quick-hacked 77_ddb/sortph.F90 and a<br />small patch for 72_response/phfrq3.F90.<br />Understand what they are, then use them.<br />But, you do NOT have to understand GROUP THEORY !!!<br /><br />This technique may be also used to plot electronic band structures.<br /><br />Ciao, ciao, <br />Takeshi Nishimatsu<br /><!-- m --><a class="postlink" href="http://loto.sourceforge.net/feram/">http://loto.sourceforge.net/feram/</a><!-- m --><br />Fast MD program for perovskite-type ferroelectrics<br /><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>!{\src2tex{textfont=tt}}<br />!!****f* ABINIT/sortph<br />!! NAME<br />!! sortph<br />!!<br />!! FUNCTION<br />!! Sort the energies in order to have fine phonon<br />!! dispersion curves<br />!! It is best not to include the gamma point in the list<br />!!<br />!! COPYRIGHT<br />!! Copyright (C) 2002-2010 ABINIT group (FDortu,MVeithen)<br />!! This file is distributed under the terms of the<br />!! GNU General Public License, see ~abinit/COPYING<br />!! or http://www.gnu.org/copyleft/gpl.txt .<br />!! For the initials of contributors, see ~abinit/doc/developers/contributors.txt .<br />!!<br />!! MODIFIED<br />!! Takeshi Nishimatsu<br />!!<br />!! INPUTS<br />!!&nbsp; displ(2,3*natom,3*natom)= contain<br />!!&nbsp; &nbsp;the displacements of atoms in cartesian coordinates.<br />!!&nbsp; &nbsp;The first index means either the real or the imaginary part,<br />!!&nbsp; &nbsp;The second index runs on the direction and the atoms displaced<br />!!&nbsp; &nbsp;The third index runs on the modes.<br />!!&nbsp; filnam=name of output files<br />!!&nbsp; &nbsp;hacmm1,hartev,harthz,xkb= different conversion factors<br />!!&nbsp; natom= number of atom<br />!!&nbsp; phfrq(3*natom)= phonon frequencies in Hartree<br />!!&nbsp; qphon(3)=phonon wavevector<br />!!&nbsp; udispl=unit number for output of phonon eigendisplacements<br />!!&nbsp; ufreq=unit number for output of phonon frequencies<br />!!<br />!! OUTPUT<br />!!&nbsp; (only writing ?)<br />!!<br />!! NOTES<br />!! Called by one processor only<br />!!<br />!! PARENTS<br />!!&nbsp; &nbsp; &nbsp; mkphbs,thm9<br />!!<br />!! CHILDREN<br />!!<br />!! SOURCE<br /><br />#if defined HAVE_CONFIG_H<br />#include &quot;config.h&quot;<br />#endif<br /><br />subroutine sortph(displ,filnam, natom,phfrq,qphon,udispl,ufreq)<br /><br />use defs_basis<br />use defs_datatypes<br />use defs_abitypes<br /><br />implicit none<br /><br />!Arguments -----------------------------------<br />!scalars<br />integer,intent(in) :: natom,udispl,ufreq<br />character(len=fnlen),intent(in) :: filnam<br />!arrays<br />complex(dp),intent(in) :: displ(3*natom,3*natom)<br />real(dp),intent(in)&nbsp; &nbsp; :: phfrq(3*natom),qphon(3)<br /><br />!Local variables-------------------------------<br />!scalars<br />integer :: iatom,imode,j,i(1)<br />character(len=fnlen) :: file_displ,file_freq<br />!arrays<br />logical&nbsp; &nbsp; &nbsp;::&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mask(3*natom)<br />real(dp)&nbsp; &nbsp; ::&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;phfrqNew(3*natom)<br />complex(dp) ::&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;displNew(3*natom,3*natom)<br />complex(dp) ::&nbsp; &nbsp; transpose_displ(3*natom,3*natom)<br />real(dp)&nbsp; &nbsp; ::&nbsp; &nbsp; &nbsp;abs_similarity(3*natom,3*natom)&nbsp; !|&lt;displNew|displLast&gt;|<br />complex(dp),allocatable,save :: displLast(:,:)<br /><br /><br />! *********************************************************************<br /><br />write(6, '(a)' )' sortph : enter '<br /><br />if(.not.allocated(displLast)) then<br />&nbsp; &nbsp;file_freq&nbsp; = trim(filnam)//&quot;.freq&quot; !---------------------------------------------------<br />&nbsp; &nbsp;write(6, '(a,a)' )' sortph : opening file ',trim(file_freq)<br />&nbsp; &nbsp;open(ufreq,FILE=trim(file_freq),STATUS='replace',ACCESS='sequential',ACTION='write')<br />&nbsp; &nbsp;write(6, '(a,a,a)' )' sortph : file ',trim(file_freq),' opened '<br />&nbsp; &nbsp;file_displ = trim(filnam)//&quot;.displ&quot; !--------------------------------------------------<br />&nbsp; &nbsp;write(6, '(a,a)' )' sortph : opening file ',trim(file_displ)<br />&nbsp; &nbsp;open(udispl,FILE=trim(file_displ),STATUS='replace',ACCESS='sequential',ACTION='write')<br />&nbsp; &nbsp;write(6, '(a,a,a)' )' sortph : file ',trim(file_displ),' opened '<br />&nbsp; &nbsp;allocate(displLast(3*natom,3*natom)) !---------------------------------------<br />&nbsp; &nbsp;phfrqNew(:) = phfrq(:)<br />&nbsp; &nbsp;displNew(:,:) = displ(:,:)<br />else<br />&nbsp; &nbsp;!Avoid gfortran 4.2.1 bug, with which you CANNOT conjg(transpose(displ))<br />&nbsp; &nbsp;transpose_displ = transpose(displ)<br />&nbsp; &nbsp;abs_similarity = abs(matmul(conjg(transpose_displ),displLast))<br />&nbsp; &nbsp;mask(:) = .true.<br />&nbsp; &nbsp;do j = 1, 3*natom<br />&nbsp; &nbsp; &nbsp; i(:) = maxloc( abs_similarity(:,j), mask(:) )<br />&nbsp; &nbsp; &nbsp; mask(i(1)) = .false.<br />&nbsp; &nbsp; &nbsp; phfrqNew(j) = phfrq(i(1))<br />&nbsp; &nbsp; &nbsp; displNew(:,j) = displ(:,i(1))<br />&nbsp; &nbsp;end do<br />endif<br /><br /><br />!&nbsp; Write frequencies in a file<br />!&nbsp; CE FORMAT DOIT ETRE REECRIT CAR CAS PARTICULIER 3*natom=15<br />write(ufreq,'(15(5d14.6))')&nbsp; (phfrqNew(j),j=1,3*natom)<br /><br />!&nbsp; write displacements in a file<br />do imode=1,3*natom<br />&nbsp; &nbsp;do iatom=1,natom<br />&nbsp; &nbsp; &nbsp; write(udispl,'(d14.6)') &amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sqrt(&nbsp; &nbsp; &nbsp; &nbsp;displNew(3*(iatom-1)+1,imode)*&nbsp; &nbsp;&amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;&nbsp; &nbsp; &nbsp;conjg(displNew(3*(iatom-1)+1,imode)) + &amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;displNew(3*(iatom-1)+2,imode)*&nbsp; &nbsp;&amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;&nbsp; &nbsp; &nbsp;conjg(displNew(3*(iatom-1)+2,imode)) + &amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;displNew(3*(iatom-1)+3,imode)*&nbsp; &nbsp;&amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;&nbsp; &nbsp; &nbsp;conjg(displNew(3*(iatom-1)+3,imode)) )<br />&nbsp; &nbsp;end do<br />end do<br /><br />displLast(:,:) = displNew(:,:)<br />write(6, '(a)' )' sortph : exit '<br /><br />end subroutine sortph<br />!!***<br /></code></pre></div><br /><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>--- 72_response/phfrq3.F90~&nbsp; &nbsp; &nbsp;2010-05-16 05:54:52.000000000 +0900<br />+++ 72_response/phfrq3.F90&nbsp; &nbsp; &nbsp; 2010-07-10 11:07:29.421562936 +0900<br />@@ -331,20 +331,20 @@<br />&nbsp; &nbsp; &nbsp; end do<br />&nbsp; &nbsp; end do<br />&nbsp; end do<br />-<br />-!Get the phonon displacements<br />- do imode=1,3*natom<br />-&nbsp; &nbsp;do idir1=1,3<br />-&nbsp; &nbsp; &nbsp;do ipert1=1,natom<br />-&nbsp; &nbsp; &nbsp; &nbsp;i1=idir1+(ipert1-1)*3<br />-&nbsp; &nbsp; &nbsp; &nbsp;index=i1+3*natom*(imode-1)<br />-&nbsp; &nbsp; &nbsp; &nbsp;displ(2*index-1)=eigvec(2*index-1)&amp;<br />-&amp;&nbsp; &nbsp; &nbsp; &nbsp;/&nbsp; sqrt(amu(typat(ipert1))*amu_emass)<br />-&nbsp; &nbsp; &nbsp; &nbsp;displ(2*index&nbsp; )=eigvec(2*index&nbsp; )&amp;<br />-&amp;&nbsp; &nbsp; &nbsp; &nbsp;/&nbsp; sqrt(amu(typat(ipert1))*amu_emass)<br />-&nbsp; &nbsp; &nbsp;end do<br />-&nbsp; &nbsp;end do<br />- end do<br />+displ=eigvec<br />+! !Get the phonon displacements<br />+!&nbsp; do imode=1,3*natom<br />+!&nbsp; &nbsp; do idir1=1,3<br />+!&nbsp; &nbsp; &nbsp; do ipert1=1,natom<br />+!&nbsp; &nbsp; &nbsp; &nbsp; i1=idir1+(ipert1-1)*3<br />+!&nbsp; &nbsp; &nbsp; &nbsp; index=i1+3*natom*(imode-1)<br />+!&nbsp; &nbsp; &nbsp; &nbsp; displ(2*index-1)=eigvec(2*index-1)&amp;<br />+! &amp;&nbsp; &nbsp; &nbsp; &nbsp;/&nbsp; sqrt(amu(typat(ipert1))*amu_emass)<br />+!&nbsp; &nbsp; &nbsp; &nbsp; displ(2*index&nbsp; )=eigvec(2*index&nbsp; )&amp;<br />+! &amp;&nbsp; &nbsp; &nbsp; &nbsp;/&nbsp; sqrt(amu(typat(ipert1))*amu_emass)<br />+!&nbsp; &nbsp; &nbsp; end do<br />+!&nbsp; &nbsp; end do<br />+!&nbsp; end do<br />&nbsp;<br />&nbsp;end subroutine phfrq3<br />&nbsp;!!***<br /></code></pre></div></div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: [anaddb] 77_ddb/sortph.F90 fails to connect branches</h3>
				<div class="date">Posted: <strong>Sat Jul 10, 2010 5:42 am</strong></div>
				<div class="author">by <strong>t-nissie</strong></div>
				<div class="content">Simplified:<br /><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>!{\src2tex{textfont=tt}}<br />!!****f* ABINIT/sortph<br />!! NAME<br />!! sortph<br />!!<br />!! FUNCTION<br />!! Sort the energies in order to have fine phonon<br />!! dispersion curves<br />!! It is best not to include the gamma point in the list<br />!!<br />!! COPYRIGHT<br />!! Copyright (C) 2002-2010 ABINIT group (FDortu,MVeithen)<br />!! This file is distributed under the terms of the<br />!! GNU General Public License, see ~abinit/COPYING<br />!! or http://www.gnu.org/copyleft/gpl.txt .<br />!! For the initials of contributors, see ~abinit/doc/developers/contributors.txt .<br />!!<br />!! MODIFIED<br />!! Takeshi Nishimatsu<br />!!<br />!! INPUTS<br />!!&nbsp; displ(2,3*natom,3*natom)= contain<br />!!&nbsp; &nbsp;the displacements of atoms in cartesian coordinates.<br />!!&nbsp; &nbsp;The first index means either the real or the imaginary part,<br />!!&nbsp; &nbsp;The second index runs on the direction and the atoms displaced<br />!!&nbsp; &nbsp;The third index runs on the modes.<br />!!&nbsp; filnam=name of output files<br />!!&nbsp; &nbsp;hacmm1,hartev,harthz,xkb= different conversion factors<br />!!&nbsp; natom= number of atom<br />!!&nbsp; phfrq(3*natom)= phonon frequencies in Hartree<br />!!&nbsp; qphon(3)=phonon wavevector<br />!!&nbsp; udispl=unit number for output of phonon eigendisplacements<br />!!&nbsp; ufreq=unit number for output of phonon frequencies<br />!!<br />!! OUTPUT<br />!!&nbsp; (only writing ?)<br />!!<br />!! NOTES<br />!! Called by one processor only<br />!!<br />!! PARENTS<br />!!&nbsp; &nbsp; &nbsp; mkphbs,thm9<br />!!<br />!! CHILDREN<br />!!<br />!! SOURCE<br /><br />#if defined HAVE_CONFIG_H<br />#include &quot;config.h&quot;<br />#endif<br /><br />subroutine sortph(displ,filnam, natom,phfrq,qphon,udispl,ufreq)<br /><br />use defs_basis<br />use defs_datatypes<br />use defs_abitypes<br /><br />implicit none<br /><br />!Arguments -----------------------------------<br />!scalars<br />integer,intent(in) :: natom,udispl,ufreq<br />character(len=fnlen),intent(in) :: filnam<br />!arrays<br />complex(dp),intent(in) :: displ(3*natom,3*natom)<br />real(dp),intent(in)&nbsp; &nbsp; :: phfrq(3*natom),qphon(3)<br /><br />!Local variables-------------------------------<br />!scalars<br />integer :: iatom,imode,j,i(1)<br />character(len=fnlen) :: file_displ,file_freq<br />!arrays<br />logical&nbsp; &nbsp; &nbsp;::&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mask(3*natom)<br />real(dp)&nbsp; &nbsp; ::&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;phfrqLocal(3*natom)<br />complex(dp) ::&nbsp; &nbsp; transpose_displ(3*natom,3*natom)<br />real(dp)&nbsp; &nbsp; ::&nbsp; &nbsp; &nbsp;abs_similarity(3*natom,3*natom)&nbsp; ! |&lt;displ|displSaved&gt;|<br />complex(dp),allocatable,save :: displSaved(:,:)<br /><br /><br />! *********************************************************************<br /><br />write(6, '(a)' )' sortph : enter '<br /><br />if(allocated(displSaved)) then<br />&nbsp; &nbsp;transpose_displ = transpose(displ)&nbsp; &nbsp;!Avoid gfortran 4.2.1 bug, with which you CANNOT conjg(transpose(displ))<br />&nbsp; &nbsp;abs_similarity = abs(matmul(conjg(transpose_displ),displSaved))&nbsp; &nbsp;! |&lt;displ|displSaved&gt;|<br />&nbsp; &nbsp;mask(:) = .true.<br />&nbsp; &nbsp;do j = 1, 3*natom<br />&nbsp; &nbsp; &nbsp; i(:) = maxloc( abs_similarity(:,j), mask(:) )<br />&nbsp; &nbsp; &nbsp; mask(i(1)) = .false.<br />&nbsp; &nbsp; &nbsp; phfrqLocal(j) = phfrq(i(1))<br />&nbsp; &nbsp; &nbsp; displSaved(:,j) = displ(:,i(1))<br />&nbsp; &nbsp;end do<br />else<br />&nbsp; &nbsp;allocate(displSaved(3*natom,3*natom)) !-------------------------------------------------<br />&nbsp; &nbsp;phfrqLocal(:) = phfrq(:)<br />&nbsp; &nbsp;displSaved(:,:) = displ(:,:)<br />&nbsp; &nbsp;file_freq&nbsp; = trim(filnam)//&quot;.freq&quot; !---------------------------------------------------<br />&nbsp; &nbsp;write(6, '(a,a)' )' sortph : opening file ',trim(file_freq)<br />&nbsp; &nbsp;open(ufreq,FILE=trim(file_freq),STATUS='replace',ACCESS='sequential',ACTION='write')<br />&nbsp; &nbsp;write(6, '(a,a,a)' )' sortph : file ',trim(file_freq),' opened '<br />&nbsp; &nbsp;file_displ = trim(filnam)//&quot;.displ&quot; !--------------------------------------------------<br />&nbsp; &nbsp;write(6, '(a,a)' )' sortph : opening file ',trim(file_displ)<br />&nbsp; &nbsp;open(udispl,FILE=trim(file_displ),STATUS='replace',ACCESS='sequential',ACTION='write')<br />&nbsp; &nbsp;write(6, '(a,a,a)' )' sortph : file ',trim(file_displ),' opened '<br />endif<br /><br />!&nbsp; Write frequencies in a file<br />!&nbsp; CE FORMAT DOIT ETRE REECRIT CAR CAS PARTICULIER 3*natom=15<br />write(ufreq,'(15(5d14.6))')&nbsp; (phfrqLocal(j),j=1,3*natom)<br /><br />!&nbsp; write displacements in a file<br />do imode=1,3*natom<br />&nbsp; &nbsp;do iatom=1,natom<br />&nbsp; &nbsp; &nbsp; write(udispl,'(d14.6)') &amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sqrt(&nbsp; &nbsp; &nbsp; &nbsp;displSaved(3*(iatom-1)+1,imode)*&nbsp; &nbsp;&amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;&nbsp; &nbsp; &nbsp;conjg(displSaved(3*(iatom-1)+1,imode)) + &amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;displSaved(3*(iatom-1)+2,imode)*&nbsp; &nbsp;&amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;&nbsp; &nbsp; &nbsp;conjg(displSaved(3*(iatom-1)+2,imode)) + &amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;displSaved(3*(iatom-1)+3,imode)*&nbsp; &nbsp;&amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;&nbsp; &nbsp; &nbsp;conjg(displSaved(3*(iatom-1)+3,imode)) )<br />&nbsp; &nbsp;end do<br />end do<br /><br />write(6, '(a)' )' sortph : exit '<br />end subroutine sortph<br />!!***<br /></code></pre></div></div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: [anaddb] 77_ddb/sortph.F90 fails to connect branches</h3>
				<div class="date">Posted: <strong>Sat Aug 07, 2010 12:31 pm</strong></div>
				<div class="author">by <strong>t-nissie</strong></div>
				<div class="content">Here is the final(?) patch for files in 6.2.1:<br /><br />* Keep 72_response/phfrq3.F90 as in 6.2.1.<br />* 77_ddb/sortph.F90: file attached.<br />* 77_ddb/interfaces_77_ddb.F90: patch attached.<br />* 77_ddb/mkphbs.F90: patch attached.<br />* 77_ddb/thm9.F90: patch attached.<br />* I put <!-- m --><a class="postlink" href="http://loto.sourceforge.net/loto/PbTiO3-new-anaddb.tar.gz">http://loto.sourceforge.net/loto/PbTiO3 ... ddb.tar.gz</a><!-- m --> , an example for this patch.<br />  Find and view PbTiO3-new-anaddb/PbTiO3-phonon-band.pdf in the tar ball.<br />  MD5 (PbTiO3-new-anaddb.tar.gz) = d829556780f7e943ea7750691c6f8530<br /><br />Note that, even with this patch, sortph.F90 fails to connect<br />branches from the Gamma point when the system has LO-TO<br />splitting. In that case, you should move data column in your<br />B2EPS.freq file by your hands.<br /><br />77_ddb/sortph.F90:<br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>!{\src2tex{textfont=tt}}<br />!!****f* ABINIT/sortph<br />!! NAME<br />!! sortph<br />!!<br />!! FUNCTION<br />!! Sort the energies in order to have fine phonon<br />!! dispersion curves<br />!! It is best not to include the gamma point in the list<br />!!<br />!! COPYRIGHT<br />!! Copyright (C) 2002-2010 ABINIT group (FDortu,MVeithen)<br />!! This file is distributed under the terms of the<br />!! GNU General Public License, see ~abinit/COPYING<br />!! or http://www.gnu.org/copyleft/gpl.txt .<br />!! For the initials of contributors, see ~abinit/doc/developers/contributors.txt .<br />!!<br />!! MODIFIED<br />!! Takeshi Nishimatsu<br />!!<br />!! INPUTS<br />!!&nbsp; eigvec(2*3*natom*3*natom)= contain<br />!!&nbsp; the eigenvectors of the dynamical matrix.<br />!!&nbsp; displ(2,3*natom,3*natom)= contain<br />!!&nbsp; &nbsp;the displacements of atoms in cartesian coordinates.<br />!!&nbsp; &nbsp;The first index means either the real or the imaginary part,<br />!!&nbsp; &nbsp;The second index runs on the direction and the atoms displaced<br />!!&nbsp; &nbsp;The third index runs on the modes.<br />!!&nbsp; filnam=name of output files<br />!!&nbsp; &nbsp;hacmm1,hartev,harthz,xkb= different conversion factors<br />!!&nbsp; natom= number of atom<br />!!&nbsp; phfrq(3*natom)= phonon frequencies in Hartree<br />!!&nbsp; qphon(3)=phonon wavevector<br />!!&nbsp; udispl=unit number for output of phonon eigendisplacements<br />!!&nbsp; ufreq=unit number for output of phonon frequencies<br />!!<br />!! OUTPUT<br />!!&nbsp; (only writing ?)<br />!!<br />!! NOTES<br />!! Called by one processor only<br />!!<br />!! PARENTS<br />!!&nbsp; &nbsp; &nbsp; mkphbs,thm9<br />!!<br />!! CHILDREN<br />!!<br />!! SOURCE<br /><br />#if defined HAVE_CONFIG_H<br />#include &quot;config.h&quot;<br />#endif<br /><br />subroutine sortph(eigvec,displ,filnam, natom,phfrq,qphon,udispl,ufreq)<br /><br />use defs_basis<br />use defs_datatypes<br />use defs_abitypes<br /><br />implicit none<br /><br />!Arguments -----------------------------------<br />!scalars<br />integer,intent(in) :: natom,udispl,ufreq<br />character(len=fnlen),intent(in) :: filnam<br />!arrays<br />complex(dp),intent(in) :: eigvec(3*natom,3*natom)<br />complex(dp),intent(in) :: displ(3*natom,3*natom)<br />real(dp),intent(in)&nbsp; &nbsp; :: phfrq(3*natom),qphon(3)<br /><br />!Local variables-------------------------------<br />!scalars<br />integer :: iatom,imode,j,i(1)<br />character(len=fnlen) :: file_displ,file_freq<br />!arrays<br />logical&nbsp; &nbsp; &nbsp;::&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;mask(3*natom)<br />real(dp)&nbsp; &nbsp; ::&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;phfrqNew(3*natom)<br />complex(dp) ::&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;displNew(3*natom,3*natom)<br />complex(dp) ::&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; eigvecNew(3*natom,3*natom)<br />complex(dp) ::&nbsp; &nbsp;transpose_eigvec(3*natom,3*natom)<br />real(dp)&nbsp; &nbsp; ::&nbsp; &nbsp; &nbsp;abs_similarity(3*natom,3*natom)&nbsp; !|&lt;displNew|displLast&gt;|<br />complex(dp),allocatable,save :: eigvecLast(:,:)<br /><br /><br />! *********************************************************************<br /><br />write(6, '(a)' )' sortph : enter '<br /><br />if(.not.allocated(eigvecLast)) then<br />&nbsp; &nbsp;file_freq&nbsp; = trim(filnam)//&quot;.freq&quot; !---------------------------------------------------<br />&nbsp; &nbsp;write(6, '(a,a)' )' sortph : opening file ',trim(file_freq)<br />&nbsp; &nbsp;open(ufreq,FILE=trim(file_freq),STATUS='replace',ACCESS='sequential',ACTION='write')<br />&nbsp; &nbsp;write(6, '(a,a,a)' )' sortph : file ',trim(file_freq),' opened '<br />&nbsp; &nbsp;file_displ = trim(filnam)//&quot;.displ&quot; !--------------------------------------------------<br />&nbsp; &nbsp;write(6, '(a,a)' )' sortph : opening file ',trim(file_displ)<br />&nbsp; &nbsp;open(udispl,FILE=trim(file_displ),STATUS='replace',ACCESS='sequential',ACTION='write')<br />&nbsp; &nbsp;write(6, '(a,a,a)' )' sortph : file ',trim(file_displ),' opened '<br />&nbsp; &nbsp;allocate(eigvecLast(3*natom,3*natom)) !---------------------------------------<br />&nbsp; &nbsp; phfrqNew(:)&nbsp; &nbsp;=&nbsp; phfrq(:)<br />&nbsp; &nbsp; displNew(:,:) =&nbsp; displ(:,:)<br />&nbsp; &nbsp;eigvecNew(:,:) = eigvec(:,:)<br />else<br />&nbsp; &nbsp;!Avoid gfortran 4.2.1 bug, with which you CANNOT conjg(transpose(displ))<br />&nbsp; &nbsp;transpose_eigvec = transpose(eigvec)<br />&nbsp; &nbsp;abs_similarity = abs(matmul(conjg(transpose_eigvec),eigvecLast))<br />&nbsp; &nbsp;mask(:) = .true.<br />&nbsp; &nbsp;do j = 1, 3*natom<br />&nbsp; &nbsp; &nbsp; i(:) = maxloc( abs_similarity(:,j), mask(:) )<br />&nbsp; &nbsp; &nbsp; mask(i(1)) = .false.<br />&nbsp; &nbsp; &nbsp; phfrqNew(j)&nbsp; &nbsp;=&nbsp; &nbsp; phfrq(i(1))<br />&nbsp; &nbsp; &nbsp; displNew(:,j) =&nbsp; displ(:,i(1))<br />&nbsp; &nbsp; &nbsp;eigvecNew(:,j) = eigvec(:,i(1))<br />&nbsp; &nbsp;end do<br />endif<br /><br /><br />!&nbsp; Write frequencies in a file<br />!&nbsp; CE FORMAT DOIT ETRE REECRIT CAR CAS PARTICULIER 3*natom=15<br />write(ufreq,'(15(5d14.6))')&nbsp; (phfrqNew(j),j=1,3*natom)<br /><br />!&nbsp; write displacements in a file<br />do imode=1,3*natom<br />&nbsp; &nbsp;do iatom=1,natom<br />&nbsp; &nbsp; &nbsp; write(udispl,'(d14.6)') &amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sqrt(&nbsp; &nbsp; &nbsp; &nbsp;displNew(3*(iatom-1)+1,imode)*&nbsp; &nbsp;&amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;&nbsp; &nbsp; &nbsp;conjg(displNew(3*(iatom-1)+1,imode)) + &amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;displNew(3*(iatom-1)+2,imode)*&nbsp; &nbsp;&amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;&nbsp; &nbsp; &nbsp;conjg(displNew(3*(iatom-1)+2,imode)) + &amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;displNew(3*(iatom-1)+3,imode)*&nbsp; &nbsp;&amp;<br />&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;&nbsp; &nbsp; &nbsp;conjg(displNew(3*(iatom-1)+3,imode)) )<br />&nbsp; &nbsp;end do<br />end do<br /><br />eigvecLast(:,:) = eigvecNew(:,:)<br />write(6, '(a)' )' sortph : exit '<br /><br />end subroutine sortph<br />!!***<br /></code></pre></div><br /><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>--- interfaces_77_ddb.F90~&nbsp; &nbsp; &nbsp; 2010-08-07 18:14:44.000000000 +0900<br />+++ interfaces_77_ddb.F90&nbsp; &nbsp; &nbsp; &nbsp;2010-08-07 18:20:11.000000000 +0900<br />@@ -1855,7 +1855,7 @@<br />&nbsp;end interface<br />&nbsp;<br />&nbsp;interface<br />- subroutine sortph(displ,filnam,&amp;&nbsp; <br />+ subroutine sortph(eigvec,displ,filnam,&amp;&nbsp; <br />&nbsp; &nbsp;&amp;&nbsp; natom,phfrq,qphon,udispl,ufreq)<br />&nbsp; &nbsp;use defs_basis<br />&nbsp; &nbsp;implicit none<br />@@ -1863,6 +1863,7 @@<br />&nbsp; &nbsp;integer,intent(in) :: udispl<br />&nbsp; &nbsp;integer,intent(in) :: ufreq<br />&nbsp; &nbsp;character(len=fnlen),intent(in) :: filnam<br />+&nbsp; real(dp),intent(in) :: eigvec(2,3*natom,3*natom)<br />&nbsp; &nbsp;real(dp),intent(in) :: displ(2,3*natom,3*natom)<br />&nbsp; &nbsp;real(dp),intent(in) :: phfrq(3*natom)<br />&nbsp; &nbsp;real(dp),intent(in) :: qphon(3)<br /></code></pre></div><br /><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>--- mkphbs.F90~ 2010-08-07 18:03:05.000000000 +0900<br />+++ mkphbs.F90&nbsp; 2010-08-07 18:05:42.000000000 +0900<br />@@ -286,7 +286,7 @@<br />&nbsp;!&nbsp; (visualization of phonon band structures)<br />&nbsp; &nbsp; if (anaddb_dtset%eivec == 4) then<br />&nbsp; &nbsp; &nbsp; tmpfilename = trim(outfile_radix)//&quot;_B2EPS&quot;<br />-&nbsp; &nbsp; &nbsp;call sortph(displ,tmpfilename,&amp;<br />+&nbsp; &nbsp; &nbsp;call sortph(eigvec,displ,tmpfilename,&amp;<br />&nbsp;&amp;&nbsp; &nbsp; &nbsp;natom,phfrq,qphon,udispl,ufreq)<br />&nbsp; &nbsp; end if<br />&nbsp;<br /></code></pre></div><br /><br /><div class="codebox"><p>Code: <a href="#" onclick="selectCode(this); return false;">Select all</a></p><pre><code>--- thm9.F90~&nbsp; &nbsp;2010-08-07 18:13:17.000000000 +0900<br />+++ thm9.F90&nbsp; &nbsp; 2010-08-07 18:16:04.000000000 +0900<br />@@ -308,7 +308,7 @@<br />&nbsp;<br />&nbsp; &nbsp; &nbsp; if (present(themflag)) then<br />&nbsp; &nbsp; &nbsp; &nbsp; if (themflag ==2)then<br />-&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;call sortph(displ, trim(outfilename_radix), natom,phfrq,qphon,udispl,ufreq)<br />+&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;call sortph(eigvec, displ, trim(outfilename_radix), natom,phfrq,qphon,udispl,ufreq)<br />&nbsp; &nbsp; &nbsp; &nbsp; end if<br />&nbsp; &nbsp; &nbsp; end if<br />&nbsp;<br /></code></pre></div></div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: [anaddb] 77_ddb/sortph.F90 fails to connect branches</h3>
				<div class="date">Posted: <strong>Sat Sep 04, 2010 11:28 am</strong></div>
				<div class="author">by <strong>mverstra</strong></div>
				<div class="content">Hi Takeshi - this is great. I have converted your sortph to the abinit coding style and will try it out.<br /><br />thanks a lot for your help<br /><br />Matthieu</div>
			</div>
			<hr />
					<div class="post">
				<h3>Re: [anaddb] 77_ddb/sortph.F90 fails to connect branches</h3>
				<div class="date">Posted: <strong>Wed Aug 09, 2017 10:29 am</strong></div>
				<div class="author">by <strong>harada57</strong></div>
				<div class="content">I am new to abinit and trying to find the lifetimes using GWA. Did you find answer to your question about where the abinit outputs the imaginary part of self energy ? <br /><br /><br /><a href="http://phenocal.org/" class="postlink"><span style="color: #ecf3f7">วิธีเล่นบาคาร่า</span></a></div>
			</div>
			<hr />
			</div>

	<div id="page-footer" class="page-footer">
		<div class="page-number">All times are <span title="Europe/Brussels">UTC+02:00</span><br />Page <strong>1</strong> of <strong>1</strong></div>
			<div class="copyright">
				<p>Powered by <a href="https://www.phpbb.com/">phpBB</a>&reg; Forum Software &copy; phpBB Limited
				</p>
							</div>
	</div>
</div>

</body>

<!-- Mirrored from forum.abinit.org/viewtopic.php?f=12&t=483&view=print by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 20 Sep 2024 21:03:11 GMT -->
</html>
